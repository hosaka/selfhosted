networks:
  proxy:

volumes:
  slskd-data:
  slskd-gluetun:

services:
  slskd:
    image: ghcr.io/slskd/slskd:0.23.2
    environment:
      - SLSKD_NO_AUTH=true
      - SLSKD_NO_HTTPS=true
      - SLSKD_REMOTE_CONFIGURATION=false
      - SLSKD_SLSK_LISTEN_PORT=63955
      - SLSKD_SLSK_USERNAME=${MEDIA_SLSKD_USERNAME}
      - SLSKD_SLSK_PASSWORD=${MEDIA_SLSKD_PASSWORD}
      # these subdirectories must exists under MEDIA_DOWNLOADS_SOULSEEK_PATH/
      - SLSKD_DOWNLOADS_DIR=/data/media/downloads/soulseek/downloads
      - SLSKD_INCOMPLETE_DIR=/data/media/downloads/soulseek/incomplete
      # uncomment the next line and the corresponding volume mount to enable sharing
      - SLSKD_SHARED_DIR=/data/media/collection
      - SLSKD_UMASK=${MEDIA_UMASK}
      - TZ=${TIMEZONE}
    extends:
      file: common.yml
      service: log-to-json
    network_mode: "service:slskd-gluetun"
    restart: unless-stopped
    user: ${MEDIA_PUID}:${MEDIA_PGID}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - slskd-data:/app
      - ${MEDIA_COLLECTION_MUSIC_PATH}:/data/media/collection/music
      - ${MEDIA_DOWNLOADS_SOULSEEK_PATH}:/data/media/downloads/soulseek

  slskd-gluetun:
    image: docker.io/qmcgaw/gluetun:v3.40.0
    cap_add:
      - NET_ADMIN
    environment:
      - VPN_TYPE=wireguard
      - VPN_SERVICE_PROVIDER=${GLUETUN_VPN_SERVICE_PROVIDER}
      - VPN_PORT_FORWARDING=on
      - HTTP_CONTROL_SERVER=on
      - SERVER_HOSTNAMES=${GLUETUN_SERVER_HOSTNAMES}
      - WIREGUARD_PRIVATE_KEY=${GLUETUN_WIREGUARD_PRIVATE_KEY}
      - TZ=${TIMEZONE}
      # todo: automatically update listenPort in slskd config
      # - VPN_PORT_FORWARDING_UP_COMMAND=/bin/sh -c 'echo {{PORTS}}'
    expose:
      - 5030 # slskd webui
      - 63955 # slskd p2p port
      - 8000 # gluetun control server
    extends:
      file: common.yml
      service: log-to-json
    networks:
      - proxy
    restart: unless-stopped
    volumes:
      - slskd-gluetun:/gluetun
